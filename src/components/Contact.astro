---
import '../styles/components/_contact.scss';

interface ContactProps {
  id?: string;
  heading?: string;
  description?: string;
  email?: string;
  projectOptions?: string[];
  endpoint?: string;
}

const defaultOptions = [
  'Solo consulta / No sé qué necesito',
  'Landing Express (1 página)',
  'Sitio empresarial (hasta 5 páginas)',
  'MVP / Web a medida',
  'Rediseño de sitio existente',
  'Optimización de velocidad (sitio existente)',
  'Integración puntual (WhatsApp / Analytics / Formularios)',
  'Mantenimiento / actualizaciones de contenido',
  'Tienda online',
  'Menú digital',
];

const {
  id = 'contacto',
  heading = 'Empezá tu proyecto hoy',
  description = 'Completá el formulario y recibí un presupuesto preliminar en menos de 24 horas hábiles. Sin compromiso.',
  email = 'hola@malayaweb.com',
  projectOptions = defaultOptions,
  endpoint = import.meta.env.PUBLIC_FORM_ENDPOINT || '',
} = Astro.props as ContactProps;

// Mensaje prellenado para WhatsApp
const whatsappMessage = 'Hola Lucas, me interesa iniciar un proyecto web. ¿Podemos hablar?';
const whatsappText = encodeURIComponent(whatsappMessage);
---
<section id={id} class="mw-contact py-24 px-6 max-w-7xl mx-auto" aria-labelledby={`${id}-title`} data-component="mw-contact">
  <div class="mw-contact__grid">
    <div class="mw-contact__intro">
      <h2 id={`${id}-title`} class="mw-contact__title">{heading}</h2>
      <p class="mw-contact__subtitle">{description}</p>

      <div class="mw-contact__info">
        <!-- Email item -->
        <div class="mw-contact__info-item">
          <div class="mw-contact__info-icon" aria-hidden="true">
            <span class="material-symbols-outlined">mail</span>
          </div>
          <div class="mw-contact__info-text">
            <p class="mw-contact__info-label">Email</p>
            <a href={`mailto:${email}`} class="mw-contact__info-value">{email}</a>
          </div>
        </div>

        <!-- WhatsApp item -->
        <div class="mw-contact__info-item">
          <div class="mw-contact__info-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
              <path fill="currentColor" d="M12.06 2.204c-5.267 0-9.538 4.27-9.538 9.538 0 1.681.44 3.245 1.21 4.63L2 22l5.77-1.51a9.514 9.514 0 004.29 1.033c5.267 0 9.538-4.27 9.538-9.538s-4.27-9.538-9.539-9.538zm0 17.414A7.863 7.863 0 014.196 11.74a7.863 7.863 0 017.864-7.864 7.863 7.863 0 017.865 7.864 7.863 7.863 0 01-7.865 7.864zm4.344-5.815c-.278-.14-1.644-.815-1.898-.906-.254-.093-.44-.14-.627.14-.188.279-.72.906-.88 1.093-.159.187-.326.21-.603.07-.278-.14-1.167-.429-2.223-1.367-.822-.733-1.377-1.635-1.536-1.914-.159-.279-.017-.43.123-.57.126-.126.278-.327.417-.49.14-.163.187-.28.28-.467.093-.187.047-.35-.023-.49-.07-.14-.627-1.515-.86-2.078-.226-.542-.457-.47-.627-.47-.163-.007-.35-.007-.537-.007-.186 0-.49.07-.746.35-.256.279-.979.958-.979 2.334 0 1.376 1.003 2.706 1.144 2.893.14.187 1.981 3.022 4.797 4.232.67.289 1.191.462 1.598.592.67.213 1.28.183 1.76.111.537-.08 1.644-.669 1.876-1.316.233-.647.233-1.198.163-1.316-.07-.119-.256-.187-.533-.327z"/>
            </svg>
          </div>
          <div class="mw-contact__info-text">
            <p class="mw-contact__info-label">WhatsApp</p>
            <a href={`https://wa.me/542223524735?text=${whatsappText}`} target="_blank" rel="noopener noreferrer" class="mw-contact__info-value" aria-label="WhatsApp: +54 2223-524735">+54 2223-524735 (Lucas)</a>
          </div>
        </div>
      </div>
    </div>

    <div class="mw-contact__form-card">
      <form id={`${id}-form`} class="mw-contact__form" action={endpoint} method="POST" novalidate aria-describedby={`${id}-note`}>
        <input type="text" name="website" class="visually-hidden" tabindex="-1" autocomplete="off" aria-hidden="true" />
        <div class="mw-contact__field">
          <label for={`${id}-name`} class="mw-contact__label">Nombre</label>
          <input id={`${id}-name`} name="name" type="text" class="mw-contact__input" placeholder="Tu nombre" autocomplete="name" />
          <p class="mw-contact__error" data-error="name"></p>
        </div>
        <div class="mw-contact__field">
          <label for={`${id}-email`} class="mw-contact__label">Correo Electrónico</label>
          <input id={`${id}-email`} name="email" type="email" class="mw-contact__input" placeholder="tu@empresa.com" autocomplete="email" />
          <p class="mw-contact__error" data-error="email"></p>
        </div>
        <div class="mw-contact__field">
          <label for={`${id}-project`} class="mw-contact__label">Tipo de Proyecto</label>
          <div class="mw-contact__select-wrap">
            <select id={`${id}-project`} name="project" class="mw-contact__select">
              {projectOptions.map((opt) => (
                <option value={opt}>{opt}</option>
              ))}
            </select>
            <span class="material-symbols-outlined mw-contact__select-icon" aria-hidden="true">expand_more</span>
          </div>
          <p class="mw-contact__error" data-error="project"></p>
        </div>
        <div class="mw-contact__field">
          <label for={`${id}-message`} class="mw-contact__label">Notas adicionales</label>
          <textarea id={`${id}-message`} name="message" class="mw-contact__textarea" placeholder="Contanos brevemente sobre tu negocio..."></textarea>
        </div>
        <button type="submit" class="mw-contact__submit">Enviar Consulta</button>
        <p id={`${id}-note`} class="mw-contact__note">Respondemos en 24 horas hábiles.</p>
        <p class="mw-contact__success" aria-live="polite"></p>
      </form>
    </div>
  </div>
</section>

<script type="module">
  const section = document.querySelector('section[data-component="mw-contact"]');
  const form = section?.querySelector('form');
  const submitBtn = form.querySelector('.mw-contact__submit');
  const successEl = form.querySelector('.mw-contact__success');
  const fields = {
    name: form.querySelector('input[name="name"]'),
    email: form.querySelector('input[name="email"]'),
    project: form.querySelector('select[name="project"]'),
    website: form.querySelector('input[name="website"]'),
  };

  function setError(field, message) {
    const input = fields[field];
    const err = form.querySelector(`.mw-contact__error[data-error="${field}"]`);
    if (message) {
      input.setAttribute('aria-invalid', 'true');
      err.textContent = message;
      err.dataset.visible = 'true';
    } else {
      input.removeAttribute('aria-invalid');
      err.textContent = '';
      err.dataset.visible = 'false';
    }
  }

  function validate() {
    let ok = true;
    setError('name');
    setError('email');
    setError('project');
    if (!fields.name.value.trim()) { setError('name', 'Ingresá tu nombre.'); ok = false; }
    const email = fields.email.value.trim();
    if (!email || !/^\S+@\S+\.\S+$/.test(email)) { setError('email', 'Ingresá un correo válido.'); ok = false; }
    if (!fields.project.value.trim()) { setError('project', 'Seleccioná un tipo de proyecto.'); ok = false; }
    return ok;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    successEl.dataset.visible = 'false';
    if (!validate()) return;
    submitBtn.disabled = true;
    const fd = new FormData(form);
    try {
      if (form.action) {
        const res = await fetch(form.action, { method: 'POST', body: fd, headers: { 'Accept': 'application/json' } });
        const data = await res.json().catch(() => ({ ok: res.ok }));
        if (!res.ok || data?.error) throw new Error(data?.error || 'Request failed');
      } else {
        await new Promise(r => setTimeout(r, 300));
      }
      successEl.textContent = '¡Gracias! Recibimos tu consulta.';
      successEl.dataset.visible = 'true';
      form.reset();
    } catch (err) {
      successEl.textContent = 'Ocurrió un error. Probá de nuevo más tarde.';
      successEl.dataset.visible = 'true';
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>
